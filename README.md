# VCR

Follow [setup instructions](#setup) to setup a project.

## Dataset

Download ImageNet dataset first to a local directory.

1. https://image-net.org/data/ILSVRC/2012/ILSVRC2012_devkit_t12.tar.gz
2. https://image-net.org/data/ILSVRC/2012/ILSVRC2012_img_val.tar

Shortcut: `make download-imagenet`

### dataset_name

`dataset_name` in configuration file should be either `imagenet` or `cifar10`.

## Setup

1. Download ImageNet dataset: `make download-imagenet` (the files are downloaded to your current directory)
2. Move the 2 downloaded files to a directory of your choice
3. Run `make init` to initialize a workspace directory
    - Use `make init-overwrite` to overwrite the existing workspace configuration

`main.py` is the entrypoint of the tool, run it using this pattern:

```bash
python main.py -w <workspace dir> <command> [<args>]
```

### Generate Configuration

To reduce number of arguments to pass in commnad line, I designed a `config.yaml` file to contain the configurations. 

```bash
python main.py -w <workspace dir> gen-config             # generate a workspace and configuration template file
python main.py -w <workspace dir> gen-config --overwrite # overwrite existing configuration file
```


### Notes

If you are developing the code, for each command, make sure the following code is added to the top

```python
w = Workspace.instance()
w.setup_workspace()
w.config.verify_config()
```

### Preprocess CIFAR10

CIFAR10 dataset is saved in pickle format, the `preprocess_cifar10.py` script will download the CIFAR10 dataset and preprocess them to follow `ImageFolder`.

```bash
python tools/preprocess_cifar10.py --data_dir ~/datasets # use your own dataset directory
```

## Loading Model

`reliabilitycli` supports all torchvision models. There is a `get_model` function in `reliabilitycli.src.utils.model`. Just pass in the model name as parameter.

```python
# sample code
model = get_model('resnet18')(pretrained=True).to(device).eval()
```

The model name should be set within workspace configuration file (`config.yaml`) using the `model_name` property.

### Custom Model

You can also choose to use your own model by writing a `model.py` and setting `model_name` to `custom`.

Just make sure the model is assigned to variable `model` in `model.py`.

```python
# sample code for model.py within workspace directory
import torch

class Model(torch.nn.Module):
    def __init__(self):
        super(Model, self).__init__()
        self.model = model
        self.model.fc = nn.Linear(512, 10)
    def forward(self, x):
        return self.model(x)

model = Model()

model.load_state_dict(torch.load(weight_path))
```

## Commands

The tool is designed to run different commands completely separately. i.e. running evaluation relies on data generated by bootstrapping from previous commnads, and doesn't require running bootstrapping for every `eval` command, this will save time.

### bootstrap

Generate Bootstrap Dataset

```bash
python main.py -w ./workspace bootstrap --num_sample_iter 2 --sample_size 10 # generate boostrap images
python main.py -w ./workspace run                                            # run evaluation
```

### retrain

Retraining is a very custom process. We have a template, but you may want to write your own script to retrain the model. In your own script, you can choose your optimizer algorithms, and adjust hyperparameters.

In `main.py`, 3 functions are used. `retrain` -> `retrain_helper` -> `train`.

The -> means the function calls the function on the right.

So you can decide which ones to override.


